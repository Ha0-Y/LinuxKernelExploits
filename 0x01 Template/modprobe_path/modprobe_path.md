## modprobe_path hijack

### modprobe_path 作用

modprobe_path是用于在Linux内核中添加可加载的内核模块，当我们在Linux内核中安装或卸载新模块时，就会执行这个程序。。他的路径是一个内核全局变量，默认为 /sbin/modprobe

```bash
cat /proc/sys/kernel/modprobe
```

### hijack

modprobe_path存储在内核本身的modprobe_path符号中，且具有可写权限。也即普通权限即可修改该值。

当用户执行错误格式的elf文件时内核调用 `call_usermodehelper(char *modprobe_path ...)`。如果我们将这个字符串指向我们自己的sh文件 ，并使用 system或 execve 去执行一个未知文件类型的错误文件，那么在发生错误的时候就可以执行我们自己的二进制文件了。

### 缓解机制

- 修改内核编译选项
```Kconfig
CONFIG_STATIC_USERMODEHELPER = y
CONFIG_STATIC_USERMODEHELPER_PATH = y  # modprobe_path 为只读，不可修改
```

## 参考

- [modprobe_path trick](https://github.com/smallkirby/kernelpwn/blob/master/technique/modprobe_path.md)