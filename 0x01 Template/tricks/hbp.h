/*
 * hardware break point
 */
#define DR_OFFSET(num) ((void *)(&((struct user *)0)->u_debugreg[num]))
void create_hbp(pid_t pid, void *addr) {
  // Set DR0: HBP address
  if (ptrace(PTRACE_POKEUSER, pid, DR_OFFSET(0), addr) != 0) {
    die("create hbp ptrace dr0: %m");
  }

  /* Set DR7: bit 0 enables DR0 breakpoint. Bit 8 ensures the processor stops
   * on the instruction which causes the exception. bits 16,17 means we stop
   * on data read or write. */
  unsigned long dr_7 = (1 << 0) | (1 << 8) | (1 << 16) | (1 << 17);
  if (ptrace(PTRACE_POKEUSER, pid, DR_OFFSET(7), (void *)dr_7) != 0) {
    die("create hbp ptrace dr7: %m");
  }
}