## 复现环境的搭建

### qemu

目前还是使用 `qemu` + `busybox` + 自己编译内核实现环境

- qemu: `apt install qemu-system-x86_64`
- busybox: [参考 blog](https://www.renshengjihe.cn/1fe7a0c955f0#%E6%9E%84%E5%BB%BA%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F)
- 内核版本： [USTC mirror](https://mirrors.ustc.edu.cn/kernel.org/)

内核编译坑很多，使用 docker 编译比较好，高版本gcc编译某些内核时特别容易出错

#### 编译 内核

- 可以参考 [basic.pdf](./basic.pdf)

1. config
```bash
make  menuconfig

# 如果使用LLVM
make CC=clang HOSTCC=clang -j8 bzImage  # 非完整版
```

编译内核时保证勾选如下配置（默认都是y，并且根据版本会有一定的变化）：
- Kernel hacking —> Kernel debugging
- Kernel hacking —> Compile-time checks and compiler options —> Compile the kernel with debug info
- Kernel hacking —> Generic Kernel Debugging Instruments –> KGDB: kernel debugger
- kernel hacking —> Compile the kernel with frame pointers

2. 内核，由于使用完整的LLVM工具链在某些版本的会出错，比如`llvm-ar not found`，存在`llvm-ar-14`,在某些内核版本编译时出错，因此使用部分的LLVM链就行
```bash
make -j8 bzImage

# 使用clang
make CC=clang HOSTCC=clang -j8 bzImage
# or
make LLVM=1 -j8 bzImage
# or
make LLVM=-15 -j8 bzImage
```

关于编译内核
```bash
$ make defconfig     # 默认配置
$ make olddefconfig  # 根据旧的config文件生成新的，内核手动更新
```

### ubuntu 更换内核

- 不需要自己配置编译，而是在虚拟机内更换。

#### apt

1. 安装 generic 版本内核

```bash
# 搜索指定版本的内核
sudo apt search 'linux-image-<version>-generic'

# 安装
sudo apt install 'linux-image-<version>-generic' linux-headers-<version>-generic
```

2. 替换

```bash
sudo update-initramfs -u -k all
sudo update-grub
reboot             # reboot 开机选项：高级驱动设置，可以选择内核

# 是否替换成功
unama -r 
```

3. 卸载

```bash
# 查看安装的内核
sudo dpkg -l | grep linux-image
# or
sudo dpkg --get-selections | grep linux-image

# 卸载
sudo dpkg --purge linux-image-<version>-generic
```

- 但是apt 源不一定有全部版本的 image

#### 网站下载deb

- [ubuntu kernel ppa](https://kernel.ubuntu.com/~kernel-ppa/mainline/) 下载符合系统的 deb
  - ppa: Personal Package Archive
  - 下载 `linux-image-xxxx-generic-xxxx.deb` && `linux-modules-xxxx-generic-xxxx.deb` && `linux-headers-xxxx--generic-xxx.deb` && `linux-headers-xxxx-all.deb`。

- 安装

```bash
sudo dkpg -i *.deb

sudo reboot
```

#### 编译好的内核安装

```bash
sudo make modules
sudo make modules_install
sudo make install
sudo update-initramfs -c -k all
sudo update-grub
sudo reboot
```