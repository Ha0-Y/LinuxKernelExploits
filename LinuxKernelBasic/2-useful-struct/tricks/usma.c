// prepare socket packet_fd
// page = mmap(NULL, 0x1000 * nr, PROT_READ | PROT_WRITE, MAP_SHARED, packet_fd, 0);
int packet_socket_setup(uint32_t block_size, uint32_t frame_size,
                        uint32_t block_nr, uint32_t sizeof_priv, int timeout) {
  int s = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));
  if (s < 0) {
    fatal("Error (AF_PACKET)");
  }

  int v = TPACKET_V3;
  int rv = setsockopt(s, SOL_PACKET, PACKET_VERSION, &v, sizeof(v));
  if (rv < 0) {
    fatal("Error setsockopt (PACKET_VERSION)");
  }

  struct tpacket_req3 req3;
  memset(&req3, 0, sizeof(req3));
  req3.tp_sizeof_priv = sizeof_priv;
  req3.tp_block_nr = block_nr;
  req3.tp_block_size = block_size;
  req3.tp_frame_size = frame_size;
  req3.tp_frame_nr = (block_size * block_nr) / frame_size;
  req3.tp_retire_blk_tov = timeout;
  req3.tp_feature_req_word = 0;

  rv = setsockopt(s, SOL_PACKET, PACKET_RX_RING, &req3, sizeof(req3));
  if (rv < 0) {
    fatal("Error setsockopt (PACKET_RX_RING)");
  }

  struct sockaddr_ll sa;
  memset(&sa, 0, sizeof(sa));
  sa.sll_family = PF_PACKET;
  sa.sll_protocol = htons(ETH_P_ALL);
  sa.sll_ifindex = if_nametoindex("lo");
  sa.sll_hatype = 0;
  sa.sll_halen = 0;
  sa.sll_pkttype = 0;
  sa.sll_halen = 0;

  rv = bind(s, (struct sockaddr *)&sa, sizeof(sa));
  if (rv < 0) {
    fatal("Error bind (AF_PACKET)");
  }

  return s;
}