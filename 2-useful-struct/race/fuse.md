## fuse

> Linux FUSE(Filesystem in Userspace)是一个Linux内核模块，允许用户空间程序通过系统调用接口来实现文件系统。FUSE允许开发人员在用户空间而不是内核空间中编写文件系统，这样就可以更轻松地开发、测试和调试文件系统，而无需修改内核代码。

Linux 5.15之后，userfaultfd机制存在两个限制：

1. 默认情况下，非特权用户不能使用该机制。
2. 即使非特权用户能够使用该机制，在没有特权的情况下，内核空间的缺页异常也无法被捕获。

fuse 允许其在用户态编程，在内核态使用 `copy_from_user()` 函数，触发缺页异常，调用 `fuse_ops->read`，而这个回调函数我们可以在用户态自定义。 

fuse系统命令
```bash
$ man fuser
$ man fusermount
$ man fusermount3
```

### fuse 使用

[libfuse](https://github.com/libfuse/libfuse) 实现了Linux FUSE的用户空间API，方便程序开发。

1. 下载源码，编译
2. apt 安装，版本更新到3, 下载3，也和本机 fusermount3 版本一致

```bash
$ locate libfuse
$ sudo apt install fuse3 libfuse3-dev
```

FUSE编程 => 实现对应的文件系统操作方法，我们就可以执行 ls 这样的文件以及目录操作
- [FUSEFs_exploitation](https://github.com/LukeGix/FUSEFs_exploitation/blob/main/fusefs.c)
- github 官方的 examples

这里以 hello 为例子
```bash
$ gcc -Wall hello.c `pkg-config fuse3 --cflags --libs` -o hello
```

编译后挂载，挂载的文件系统的部分属性由我们控制。

```bash
$ mkdir -p exploit
$ ./hello exploit
$ mount           # 查看是否挂载
/home/ubuntu/fuse/hello on /home/ubuntu/fuse/exploit type fuse.hello (rw,nosuid,nodev,relatime,user_id=1000,group_id=1000)
```

### 暂停进程

FUSE文件操作的`read callback`函数：当*缺页异常*发生时，FUSE callback将被调用。

有一点需要明确—— UAF read 和 UAF write 对应的都是**FUSE read callback**，这里并不需要write callback。为什么呢？因为FUSE callback发生在文件访问过程，并不是内存页的访问过程。虽然漏洞内核模块对于用户空间内存页的访问是有读有写的，但是从引发缺页异常到 FUSE callback 处理，对于文件来说，它都是**首先被读到内存页**中。读和写只是针对内存页而言的。

```cpp
fuse_file_read_iter()
  fuse_cached_read_iter()
    generic_file_read_iter(iocb, to);
  fuse_direct_read_iter();
    ...
```

1. fuse 挂载文件系统， open打开文件，使用 mmap 映射 fd
2. 访问 mmap 地址，读写缺页异常(copy_to/from_user 访问页)
3. 在回调函数执行任意读写问题


但是apt直接安装的fuse不能静态编译
```bash
$ gcc -Wall hello.c -static `pkg-config fuse3 --cflags --libs` -o hello
/usr/bin/ld: /usr/lib/gcc/x86_64-linux-gnu/13/../../../x86_64-linux-gnu/libfuse3.a(fuse.c.o): in function `fuse_get_module':
(.text+0xe59): warning: Using 'dlopen' in statically linked applications requires at runtime the shared libraries from the glibc version used for linking
```

我们想要获得fuse静态编译，我们得参考这个[仓库](https://github.com/Crusaders-of-Rust/CVE-2022-0185)直接使用或者像其修改源码获得静态库



## 参考文章

- [libfuse official](https://libfuse.github.io/doxygen/hello_8c.html)
- [fuse in kernel](https://www.kernel.org/doc/html/latest/filesystems/fuse.html)
- [how to use fuse](https://www.maastaar.net/fuse/linux/filesystem/c/2016/05/21/writing-a-simple-filesystem-using-fuse/)
- [fuse hack 101](https://exploiter.dev/blog/2022/FUSE-exploit.html)
- [demo](https://github.com/LukeGix/FUSEFs_exploitation)